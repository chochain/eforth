<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>eForth: - Experimental implementation for Tuning and Sizing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">eForth
   &#160;<span id="projectnumber">v4.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('5.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title"><ul>
<li>Experimental implementation for Tuning and Sizing </li>
</ul>
</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h3>Why</h3>
<p>Even with vocabulary, multi-tasking, and metacompilation (the black-belt stuffs of Forth greatness) delibrately dropped to reduce the complexity, eForth traditionally uses linear memory to host words of the entire dictionary, including codes and their parameters with a backward linked-list and hence the well-known term threading. This model is crucial when memory is scarce or compiler resource is just underwhelming. It, however, does create extra hurdle that sometimes hinder the learning of newbies.</p>
<h3>Synopsis</h3>
<p>With C++ implementation of Forth as the back drop, I experimented with verious changes to the classic Forth linear-memory model detailed in next section. By manually turning the rocks under each memory management scenarions to find out what could we do better. At the end of the day, the simplest vector-based token-threading implementation with just C++ compiler optimizer actually out perform all the following tuning, 10% on AMD and 25% on ESP32. So, respect Dr. Ting's original goal of creating an educational platform, I have decided to stick with the simplest, shortest code-base.</p>
<h3>Experimental Changes - what have we tested on ceForth_40</h3>
<p>** 1: Separation of parameter memory and dictionary** </p><pre>
+ it makes dictionary uniform size which eliminates the need for link field<ul>
<li>the down side is that it requires manual array size tuning
</li>
</ul>
</pre><pre>eForth_33 uses functions i.g. CODE, LABEL, HEADER, ... as macros to assemble dictionary which just mimicing how classic Forth creates the dictionary. Visually, it is not that different from using Forth which is challenging for new comers.</pre><pre>** 2: Use struct to host a dictionary entry**
<pre>
struct <a class="el" href="structCode.html" title="Forth operator.">Code</a> {
    string name;
    void   (*xt)(void);
    int    immd;
};
+ it simpify the classic field management of Forth<ul>
<li>extra space to store the name and code pointers
</li>
</ul>
</pre></pre><pre><pre>** 3: Build array-based dictionary**
<pre>
Code* primitives[] = {
    CODE("dup",  stack[++S] = top),
    CODE("drop", <a class="el" href="ceforth__36x_8cpp.html#a163177f1a0b7d847bc3241809dafc097">pop()</a>),
    CODE("over", <a class="el" href="ceForth__40a_8cpp.html#a00ad37b38b42401fa6afc1c2b1c6f2cf">push(stack[S])</a>),
    ...
    CODE("+",    top += <a class="el" href="ceforth__36x_8cpp.html#a163177f1a0b7d847bc3241809dafc097">pop()</a>),
    CODE("-",    top -= <a class="el" href="ceforth__36x_8cpp.html#a163177f1a0b7d847bc3241809dafc097">pop()</a>),
    CODE("*",    top *= <a class="el" href="ceforth__36x_8cpp.html#a163177f1a0b7d847bc3241809dafc097">pop()</a>),
    CODE("/",    top /= <a class="el" href="ceforth__36x_8cpp.html#a163177f1a0b7d847bc3241809dafc097">pop()</a>),
    ...
    CODE("delay", sleep(pop())),
    ...
};
+ it makes the size of dictionary entries uniform
+ it removes the need for threading the linked-list (and link field)
+ using lambda syntax makes the intention easy to understand
+ OS library functions can be called directly by opcode
</pre></pre></pre><pre><pre>C language on modern OS have good libraries for I/O interfaces, the classic way of TX/RX bytes or using block to manage files are no more essential. They were necessary, but no more for today's Forth.</pre></pre><pre><pre>** 4: Use Streams for input/output**
<pre>
CODE(".",  cout &lt;&lt; <a class="el" href="ceforth__36x_8cpp.html#a163177f1a0b7d847bc3241809dafc097">pop()</a> &lt;&lt; " "),
CODE("cr", cout &lt;&lt; ENDL),
+ the I/O opcodes are easy to write and understand
+ they can be easily redirected to/from various interfaces/devices
</pre><p> or </p><pre>
while (cin &gt;&gt; idiom) {
    int w = find_word(idiom);
    if (w) {
        if (compile &amp;&amp; !dict[w].immd) comma(w);
        else                          run(w);
    }
    else {
        int n = get_number(idiom);
        if (compile) comma(n);
        else         <a class="el" href="ceForth__40a_8cpp.html#a00ad37b38b42401fa6afc1c2b1c6f2cf">push(n)</a>;
    }
}
+ our outer-interpreter is understandable even without any comment
</pre></pre></pre><pre><pre>Dr. Ting latest ceForth uses the token indirect threading model. It is great for learning as wll as being portable. The extra lookup for token to function pointer makes it slower (at about 50%) of a subroutine indirect threading model.</pre></pre><pre><pre>** 5: Using 16-bit xt offset in parameter field (instead of full 32 or 64 bits)**
<pre>
+ it avoids the double lookup of token threaded indexing
+ it reduces parameter storage requirement from 32-bit to 16-bit
+ it speeds up by reading only 2-bytes from RAM instead of 4-bytes (cache hit more)
+ it unifies xt/pfa parameter storage
+ it uses the LSB for id flag (2-byte aligned, so LSB is free)<ul>
<li>it limits function pointer spread to 64KB range</li>
<li>the words created are not binary portable anymore
</li>
</ul>
</pre></pre></pre><pre><pre><pre>#<h2>Memory Structures</h2>
</pre></pre></pre><pre><pre><pre>
<b>Struct to host a dictionary entry</b>
<pre>
Universal functor (no STL) and <a class="el" href="structCode.html" title="Forth operator.">Code</a> class
  <a class="el" href="structCode.html" title="Forth operator.">Code</a> class on 64-bit systems (expand pfa possible)
  +-------------------+-------------------+
  |    *name          |       xt          |
  +-------------------+----+----+---------+
                      |attr|pfa |xxxxxxxxx|
                      +----+----+---------+
  <a class="el" href="structCode.html" title="Forth operator.">Code</a> class on 32-bit systems (memory best utilized)
  +---------+---------+
  |  *name  |   xt    |
  +---------+----+----+
            |attr|pfa |
            +----+----+
  <a class="el" href="structCode.html" title="Forth operator.">Code</a> class on WASM/32-bit (a bit wasteful)
  +---------+---------+---------+
  |  *name  |   xt    |attr|xxxx|
  +---------+----+----+---------+
            |pfa |xxxx|
            +----+----+
</pre></pre></pre></pre><pre><pre><pre>**Macros to build dictionary entry*8
<pre>
#define <a class="el" href="orig_240x_2ceforth_8h.html#a63360857d379d2ff485bb343e52184ac">ADD_CODE(n, g, im)</a> {    \
    <a class="el" href="structCode.html" title="Forth operator.">Code</a> c(n, []{ g; }, im);    \
    dict.push(c);               \
    }
#define <a class="el" href="src_2ceforth_8cpp.html#a490de61fb7c91d13a8c01c38e7bc55a7">CODE(n, g)</a> <a class="el" href="orig_240x_2ceforth_8h.html#a63360857d379d2ff485bb343e52184ac">ADD_CODE(n, g, false)</a>
#define <a class="el" href="src_2ceforth_8cpp.html#a3cf456b56a0211b127a0f7e446488a9e">IMMD(n, g)</a> <a class="el" href="orig_240x_2ceforth_8h.html#a63360857d379d2ff485bb343e52184ac">ADD_CODE(n, g, true)</a>
</pre></pre></pre></pre><pre><pre><pre><b>Global memory blocks</b>
<pre>
  Dictionary structure (N=E4_DICT_SZ in config.h)
     dict[0].xt ---------&gt; pointer to primitive word lambda[0]
     dict[1].xt ---------&gt; pointer to primitive word lambda[1]
     ...
     dict[N-1].xt -------&gt; pointer to last primitive word lambda[N-1]</pre></pre></pre></pre><pre><pre><pre><pre>  Parameter memory structure (memory block=E4_PMEM_SZ in config.h)
     dict[N].xt ----+ user defined colon word)    dict[N+1].xt------+
                    |                                               |
     +--MEM0        v                                               v
     +--------------+--------+--------+-----+------+----------------+-----
     | str nameN \0 |  parm1 |  parm2 | ... | ffff | str nameN+1 \0 | ...
     +--------------+--------+--------+-----+------+----------------+-----
     ^              ^        ^        ^     ^      ^
     | strlen+1     | 2-byte | 2-byte |     |      |
     +--------------+--------+--------+-----+------+---- 2-byte aligned</pre></pre></pre></pre><pre><pre><pre><pre>  Parameter structure - 16-bit aligned (use LSB for colon word flag)
     primitive word (16-bit xt offset with LSB set to 0)
     +--------------+-+
     | dict.xtoff() |0|   call (XT0 + *IP)() to execute
     +--------------+-+   this save the extra memory lookup for xt</pre></pre></pre></pre><pre><pre><pre><pre>     colon (user defined) word (16-bit pmem offset with LSB set to 1)
     +--------------+-+
     |  dict.pfa    |1|   next IP = *(MEM0 + (*IP &amp; ~1))
     +--------------+-+
 </pre> </pre></pre></pre></div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
